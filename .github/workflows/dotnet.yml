name: Build Certify

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Certify
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
      
    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
      
    - name: Restore NuGet packages
      run: nuget restore Certify.sln
      
    - name: Build with MSBuild
      run: msbuild Certify.sln /p:Configuration=Release /p:Platform="Any CPU" /p:RestorePackages=false
      
    - name: List build output for debugging
      run: |
        dir Certify\bin\Release\ /s
      
    - name: Copy build output
      shell: pwsh
      run: |
        # Create publish directory
        New-Item -ItemType Directory -Path "publish" -Force
        
        # Check which directories actually exist and copy from them
        $sourceDirs = @(
            "Certify\bin\Release\net6.0\win-x64",
            "Certify\bin\Release\net6.0"
        )
        
        foreach ($dir in $sourceDirs) {
            if (Test-Path $dir) {
                Write-Host "Copying from: $dir"
                Copy-Item -Path "$dir\*" -Destination "publish\" -Force -Recurse
            }
        }
      
    - name: List published files
      run: dir publish\ /s
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Certify
        path: ./publish/
        retention-days: 7
