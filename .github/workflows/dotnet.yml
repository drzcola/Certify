name: Build Certify

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Certify
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
      
    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
      
    - name: Restore NuGet packages
      run: nuget restore Certify.sln
      
    - name: Build with MSBuild
      run: msbuild Certify.sln /p:Configuration=Release /p:Platform="Any CPU" /p:RestorePackages=false
      
    - name: List build output for debugging (PowerShell)
      shell: pwsh
      run: |
        Write-Host "=== Checking build output structure ==="
        if (Test-Path "Certify\bin\Release") {
            Get-ChildItem -Path "Certify\bin\Release" -Recurse | Format-Table Name, FullName
        } else {
            Write-Host "Release directory not found!"
            # Check what directories actually exist
            Write-Host "=== Available directories ==="
            Get-ChildItem -Path "Certify\bin\" -Recurse -Directory | Format-Table FullName
        }
      
    - name: Copy build output
      shell: pwsh
      run: |
        # Create publish directory
        New-Item -ItemType Directory -Path "publish" -Force
        
        # Check which directories actually exist and copy from them
        $possiblePaths = @(
            "Certify\bin\Release\net6.0\win-x64\publish\*",
            "Certify\bin\Release\net6.0\win-x64\*",
            "Certify\bin\Release\net6.0\publish\*", 
            "Certify\bin\Release\net6.0\*",
            "Certify\bin\Release\*"
        )
        
        foreach ($path in $possiblePaths) {
            $dir = Split-Path $path -Parent
            if (Test-Path $dir) {
                Write-Host "Copying from: $dir"
                Copy-Item -Path $path -Destination "publish\" -Force -Recurse
            }
        }
      
    - name: List published files
      shell: pwsh
      run: |
        Write-Host "=== Published files ==="
        if (Test-Path "publish") {
            Get-ChildItem -Path "publish" -Recurse | Format-Table Name, Length, LastWriteTime
        } else {
            Write-Host "No files published!"
        }
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Certify
        path: ./publish/
        retention-days: 7
